Flex is a non-commercial implementation of the lex.
Flex is self-hosting in the sense that it uses a scanner generated by flex, and as far as I can tell it always has been.
The earliest versions of flex I can find use scan.l to define the lexer, and may also provide a generated C scanner for bootstrapping purposes.
scan.l uses flex-only features as far back as I can find, so it has never been possible to compile flex as-is starting with lex.

## Rewriting scan.l

[bootstrap-scan.l](bootstrap-scan.l) is the scan.l source file from flex-2.6.4, rewritten to be compatible with lex.

A summary of the changes I made are:

* Remove all `%option` lines
* Change all `%x` directives to `%s`

    The only rule in scan.l without an explicit start condition is the <*> catchall rule, so changing the start conditions from exclusive to inclusive does not change the scanner behavior.

* Remove `<*>` from the catch-all rule
* Remove all rules that match `<<EOF>>`
* Add options to increase all of the lex array sizes

    There were some different expectations around memory sizes in 1979, and I didn't bother changing any of them in the lex sources.
    The original lex allowed a lot of the array sizes to be configured at runtime, though.
    
    The directives added for this purpose are `%a`, `%e`, `%k`, `%n`, `%o`, and `%p`.

* Replace all character class matches

    The `[[:xxx:]]` character classes didn't exist back then.
    Replace all of the ones used with the ASCII ranges that would be matched.

* Remove everything that uses the `LINEDIR` state

    This is used to support `#line ...` preprocessor directives in the lex sources.
    This feature is not used in scan.l, and it's easier to delete a state stack usage than it is to reimplement it.

* Remove most of the `PERCENT_BRACE_ACTION` state and rules

    This is another feature unused in scan.l that adds complications I'd rather not deal with, but the `<PERCENT_BRACE_ACTION>{ ... }` rules section is a bit unusual.
    There are two rules in that section that also apply to the `<ACTION>` and `<CODEBLOCK>` start states, so move those to the top-level rules and delete the rest.

* Move the indented code at the top of the rules section up to the `%{...%}` block in section 1
* Flatten the start state blocks

    For something of the form

    ```
    <STATE>{
      RuleA ...
      RuleB ...
    }
    ```

    change it to

    ```
    <STATE>RuleA ...
    <STATE>RuleB ...
    ```

* Add braces to all of the multi-statement actions that are not already in braces
* Remove all comments from the rules section that are outside of action braces

    For actions that are just a comment, replace it with `;`

* Replace all `yy_push_state`/`yy_pop_state` calls

    This required an extra state to handle entering and leaving one of the start state paths

* Redo the transition from `SECT2PROLOG` to `SECT2`

    Flex handles the transition from indented section 2 prologue code to unindented (but possibly later indented again) rules by matching the first line that does not start with whitespace, calling `yyless` on the whole thing, calling `yy_set_bol(1)`, and calling `BEGIN(SECT2)`.
    The part not supported by lex is `yy_set_bol`, which resets the beginning of line state and allows the `SECT2` rules to use `^` anchors with the data that was returned to the input buffer.

    Work around this by creating a new state, `SECT2FIRSTCHAR`, and rewriting all `SECT2` rules that do not include whitespace at the beginning to add `SECT2FIRSTCHAR`. The ones that include a `^` anchor are rewritten to match without the anchor in `SECT2FIRSTCHAR`.

* Replace the remaining `yyterminate` usages with `return 0`
* Remove a `YY_START` usage by splitting the action into separate rules
* Replace trailing context rules

    These are rules of the form `a/b`, where all of `a` and `b` must occur but only `a` is provided as the match.
    Replace the expressions with `ab` and just unput the `b` characters in the action.
    

## Generating the parser

Both AT&T lex and flex use yacc to generate a parser.
[byacc](https://invisible-island.net/byacc/byacc.html) is probably your best bet for generating the parser, since it is written entirely in C.

[GNU Bison](https://www.gnu.org/software/bison/) is implemented with both lex and bison sources, making it a poor choice for a starting point.
Once you have a working flex, however, [bison-bootstrap](https://gitlab.com/giomasce/bison-bootstrap) can be used to bootstrap GNU Bison.

## Putting it all together

The bootstrap.sh script in this directory goes through the steps needed to build flex without a prior version of flex or a generated scanner.
The autoconf scripts are bypassed as well, to avoid needing to deal with the check for flex or whatever other crap that stuff pulls in.
The end result is a binary `./flex/src/flex` using a lex-generated scanner that can be used to re-generated scan.c and compile a flex-hosted flex.
